# Quanta II 程式開發說明

## 專案概述
Quanta II 是一個量化交易策略開發與回測系統，提供完整的策略開發、回測和績效分析功能。

## 系統架構
系統分為四個主要模組：
1. M0: 歷史資料下載模組
2. M1: 策略信號產生模組
3. M2: 策略回測模組
4. M3: 績效篩選與報告模組

## 開發進度

### 已完成功能
1. 主控程式 (main_controller.py)
   - 完整的選單系統
   - 模組化設計
   - 使用者輸入驗證
   - 錯誤處理機制

2. 歷史資料下載模組 (M0)
   - 支援多種資料來源
   - 自動資料清理與格式化
   - 資料儲存與管理

3. 策略信號產生模組 (M1)
   - 支援多種技術指標
   - 可擴展的策略框架
   - 信號輸出標準化

4. 策略回測模組 (M2)
   - 支援多種交易模式
   - 考慮手續費和滑點
   - 完整的績效計算
   - 結果自動匯出

5. 績效篩選與報告模組 (M3)
   - 多維度績效分析
   - 彈性篩選條件
   - 多種報告格式支援
   - 自動報告產生

### 最新更新
1. 新增 RSI 策略信號產生器
   - 支援多種 RSI 參數設定
   - 可自定義超買超賣閾值
   - 信號產生邏輯優化

2. 回測系統優化
   - 新增交易時機選擇
   - 支援固定股數和百分比倉位
   - 績效計算精確度提升

3. 報告系統增強
   - 新增 Top N 和 Top % 模式
   - 支援多種排序依據
   - 彈性篩選條件
   - 多格式輸出支援 (CSV/XLSX/HTML)

## 開發日誌

### 2024-03-21: RSI 策略實作與系統優化

#### 開發內容
- 新增 RSI 策略信號產生器
- 優化回測系統
- 增強報告系統
- 更新程式開發說明檔

#### 主要更新
1. 主控程式 (main_controller.py)
   - 新增 RSI 策略支援
   - 優化使用者輸入驗證
   - 改進錯誤處理機制

2. 資料載入模組 (m0_data_loader.py)
   - 優化資料處理流程
   - 新增資料驗證機制

3. 配置模組 (config.py)
   - 新增 RSI 策略相關配置
   - 優化配置管理

#### 測試結果
- 成功執行 RSI 策略回測
- 成功產生績效報告
- 系統穩定性提升

#### 後續規劃
- 新增更多技術指標
- 優化回測效能
- 增強報告視覺化

### 2024-06-09: M2/M3 結構與可追溯性最佳化

#### 主要修正
1. **M2 回測結果資料夾結構**
   - 每次批次回測結果會自動建立於 results/下，資料夾名稱與 signals 子資料夾一致（如 `SMA_CROSS_AAPL_20250609_002255`）。
   - 同一批次所有參數組合的績效與 NAV 檔案皆集中於該資料夾下。
   - 每個資料夾內有獨立的 performance_master.csv，方便追蹤與管理。

2. **params 欄位正確性**
   - params 會自動從信號檔案同資料夾下的 param_log 讀取，確保每筆績效都能正確對應參數內容。
   - param_id 統一為四位數（如 0100），避免混用。

3. **M3 報告可追溯性**
   - 報告可根據 strategy、symbol、param_id、params 追溯每筆績效來源。
   - params 欄位完整顯示 JSON 格式參數。
   - 支援 Top N/Top %、條件式篩選與多格式輸出。

4. **最佳實踐**
   - signals、results 資料夾結構一一對應，便於批次管理。
   - 建議每次回測前清理舊的 performance_master.csv，避免舊資料混入。
   - 若有多策略、多股票，可分資料夾管理信號與回測結果。

### 2024-06-09: M3 報告模組優化與股票選擇功能

#### 主要更新
1. **M3 報告模組改進**
   - 新增股票代碼選擇功能
   - 報告檔案命名加入股票代碼（如 `top100_AAPL_total_return.csv`）
   - 支援多股票報告並存，避免覆蓋
   - 優化報告內容格式與可讀性

2. **報告生成功能增強**
   - 自動顯示可用股票列表
   - 支援按股票代碼篩選資料
   - 報告檔案名稱格式：`{prefix}_{symbol}_{metric}.{format}`
   - 支援 CSV、XLSX、HTML 多種輸出格式

3. **使用者體驗優化**
   - 新增股票選擇介面
   - 提供可用股票列表
   - 錯誤處理機制改進
   - 操作流程優化

#### 使用說明
1. 執行 M3 模組時，系統會顯示可用股票列表
2. 選擇要分析的股票代碼
3. 設定排序和篩選條件
4. 選擇輸出格式
5. 系統會生成包含股票代碼的報告檔案

#### 最佳實踐
1. 建議每次分析前確認目標股票
2. 不同股票的報告會分別保存
3. 可根據需要選擇不同的輸出格式
4. 報告檔案名稱包含完整資訊，方便識別

---

## 使用說明

### 主控程式操作
1. 執行 `python main_controller.py`
2. 選擇功能編號 (1-5)
3. 依照提示輸入必要參數

### 策略回測流程
1. 選擇 M2 功能
2. 輸入信號檔案路徑
3. 設定回測參數
4. 執行回測
5. 查看結果

### 績效報告產生
1. 選擇 M3 功能
2. 輸入 summary 檔案路徑
3. 設定排序和篩選條件
4. 選擇輸出格式
5. 查看報告

## 待開發功能
1. 即時交易介面
2. 風險管理模組
3. 策略優化工具
4. 視覺化儀表板
5. 多策略組合分析

## 注意事項
1. 請確保資料目錄結構正確
2. 回測前需先產生策略信號
3. 報告產生前需先執行回測
4. 注意檔案權限設定

## 開發環境
- Python 3.8+
- 必要套件：pandas, numpy, yfinance
- 建議使用虛擬環境

## 貢獻指南
1. Fork 專案
2. 建立功能分支
3. 提交變更
4. 發起 Pull Request

## 授權說明
本專案採用 MIT 授權條款

## 近期重要修正與最佳實踐

### 1. 信號檔案命名規則
- 信號檔案命名統一為 `<策略名稱>_<股票代碼>_<參數編號>.csv`，例如：
  - `SMA_CROSS_AAPL_0001.csv`
  - `SMA_CROSS_TSLA_0002.csv`
- 參數對照表命名為 `param_log_<策略名稱>_<股票代碼>.json`
- 信號-參數對應表命名為 `signal_param_map_<策略名稱>_<股票代碼>.json`

### 2. M2 回測模組
- 支援一次輸入多個 signal 檔案（逗號分隔），自動批次回測。
- 檔名解析邏輯修正，能正確處理多段策略名稱（如 `SMA_CROSS`），確保：
  - `strategy = SMA_CROSS`
  - `symbol = AAPL`
  - `param_id = 0001`
- 回測結果（performance_master.csv）會正確記錄：
  - `strategy`、`symbol`、`param_id`、`params`、`total_return`、`max_drawdown`、`run_id`
- params 欄位會正確顯示每組參數內容（JSON 格式）

### 3. M3 報告模組
- 報告會自動顯示所有關鍵欄位，並可根據 `strategy`、`symbol`、`param_id`、`params` 進行篩選與排序。
- 支援 Top N、Top %、條件式篩選。
- 若有舊格式資料，建議手動清理 `performance_master.csv`，只保留新格式資料。

### 4. 使用者體驗優化
- M2/M3 輸入錯誤（如欄位拼字錯誤）會有明確錯誤提示。
- 建議未來可加入自動提示可用欄位、批次自動偵測 signal 檔案等功能。

### 5. 系統設計原則
- 每支股票、每組參數都產生獨立信號檔案，絕不覆蓋。
- 所有回測結果集中於 performance_master.csv，方便後續分析。
- 報告內容可追溯每一筆績效的來源策略、股票、參數。

---

## 其他章節（略，請參考原始文檔） 